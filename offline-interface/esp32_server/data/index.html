<!DOCTYPE html>
<html>
<head>
  <title>Painel de Configuracao - Smart Farm</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <!-- links das abas -->
  <div class="tab">
    <button class="tablinks" onclick="openTab(event,'wifi')" id="defaultOpen">WiFi</button>
    <button class="tablinks" onclick="openTab(event, 'status')">Status</button>
    <button class="tablinks" onclick="openTab(event, 'config')">Configurar</button>
  </div>


  <!-- Conteudo das abas -->
  <div id="wifi" class="tabcontent">
    <div style="overflow-x: auto;">
      <table id="wifi-nets">
        <h1>Painel de Configuracao - Smart Farm</h1>
        <h3>Redes WiFi Disponiveis</h3>
        <tr>
          <th>Nome</th>
          <th>Criptografia</th>
          <th>Rede Aberta</th>
          <th>Conectar</th>
        </tr>
        <tr>
          <td id="rede1">Rede 1 nome</td>
          <td id="rede1_crypt">WPA-PSK</td>
          <td id="rede1_isopen">Não</td>
          <td><button id="connect" onclick="connectToNet('rede1', 'rede1_isopen')">Conectar</button></td>
        </tr>
        
      </table>
      <br>
      <button class="btn">Refresh</button>

    </div>

    <!-- The Modal -->
    <div id="pwdmodal" class="modal">

      <!-- Modal content -->
      <div class="modal-content">
        <div class="modal-header">
          <span class="close">&times;</span>
          <h2 id="modal_net_name">Rede</h2>
        </div>
        <div class="modal-body">
          <form>
            <label for="pwd">Digite a senha:</label><br>
            <input type="text" id="pwd" name="password">
          </form>
          <br>
          <button class="btn" onclick="attemptConnection()">Conectar</button>
          <p id="warnmsg" hidden>O dispositivo tentará se conectar a esta rede, você pode fechar esta aba...</p>
        </div>
      

    </div>


  <div id="status" class="tabcontent">
    <p>conteudo por adicionar</p>
  </div>

  <div id="config" class="tabcontent">
    <p>
      conteudo por adicionar
    </p>
  </div>


</body>
</html>

<script>

let ws = new WebSocket("ws://%PLACEHOLDER%/ws");
ws.onopen = function(){
  console.log("CONNECTED!");
}


ws.onmessage = function(event){
  console.log(event);
  parseObjs(event.data);
}

function parseObjs(msg){

  let obj = JSON.parse(msg);
  console.log(obj);
  document.getElementById("rede1").innerHTML = obj.netname;
  document.getElementById("rede1_crypt").innerHTML = obj.encryption;
  document.getElementById("rede1_isopen").innerHTML = obj.openNet;


}

// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();

function openTab(e, tabName){

  var i, tabcontent, tablinks;

  // Get all elements with class="tabcontent" and hide them
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }

  // Get all elements with class="tablinks" and remove the class "active"
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }

  // Show the current tab, and add an "active" class to the button that opened the tab
  document.getElementById(tabName).style.display = "block";
  e.currentTarget.className += " active";
}

let modal = document.getElementById("pwdmodal");
let btn = document.getElementById("connect"); // make a btn function
let span = document.getElementsByClassName("close")[0];

// opens the modal
//btn.onclick = function(){
//  modal.style.display = "block";
//}

// this function should send info to the board
function connectToNet(netNameId, isOpenId){
  
  let netName = document.getElementById(netNameId).innerHTML;
  let isOpen = document.getElementById(isOpenId).innerHTML;

  console.log(netName);
  console.log(isOpen);

  

  // if net isnt open, pop modal for pwd typing
  if(isOpen == 'Não'){

    document.getElementById("modal_net_name").innerHTML = netName;
    modal.style.display = 'block'

  }

}

// here be connection functions
function attemptConnection(){
  // TODO: add some delay here
  msg = document.getElementById("warnmsg");
  msg.hidden = false;
  

}

// closes the modal
span.onclick = function(){
  modal.style.display = "none";
}

// when user clicks outside of modal, close it
window.onclick = function(event){
  if(event.target == modal){
    modal.style.display = "none";
  }
}

</script>
